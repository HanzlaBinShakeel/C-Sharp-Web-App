@model FinanceApp.Models.ViewModels.VoucherViewModel
@{
    ViewData["Title"] = "Journal Entry";
}

<div class="row">
    <div class="col-xl-12">
        <div class="page-header">
            <h2 class="pageheader-title">Journal Entry</h2>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-body">
                <form asp-action="Create" method="post" id="journalForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="EntryDate"></label>
                                <input asp-for="EntryDate" class="form-control" type="date" />
                                <span asp-validation-for="EntryDate" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="ReferenceNumber"></label>
                                <input asp-for="ReferenceNumber" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Description"></label>
                                <input asp-for="Description" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <h5>Entry Lines</h5>
                    <div id="entryLines">
                        @for (int i = 0; i < Model.Lines.Count; i++)
                        {
                            <div class="row entry-line mb-2">
                                <div class="col-md-4">
                                    <select asp-for="Lines[i].LedgerID" class="form-control ledger-select" asp-items="@(new SelectList(ViewBag.Ledgers, "LedgerID", "LedgerName"))">
                                        <option value="">Select Ledger</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input asp-for="Lines[i].DebitAmount" class="form-control debit-amount" type="number" step="0.01" placeholder="Debit" />
                                </div>
                                <div class="col-md-3">
                                    <input asp-for="Lines[i].CreditAmount" class="form-control credit-amount" type="number" step="0.01" placeholder="Credit" />
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger remove-line">Remove</button>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-secondary" id="addLine">Add Line</button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>Total Debit: <span id="totalDebit">0.00</span></strong>
                        </div>
                        <div class="col-md-6">
                            <strong>Total Credit: <span id="totalCredit">0.00</span></strong>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div id="balanceError" class="alert alert-danger" style="display:none;">
                                Total Debits must equal Total Credits!
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">Post Journal</button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
            var lineIndex = @Model.Lines.Count;
            var ledgers = @Html.Raw(Json.Serialize(ViewBag.Ledgers ?? new List<object>()));

            function updateTotals() {
                var totalDebit = 0;
                var totalCredit = 0;
                
                $('.debit-amount').each(function() {
                    totalDebit += parseFloat($(this).val()) || 0;
                });
                
                $('.credit-amount').each(function() {
                    totalCredit += parseFloat($(this).val()) || 0;
                });
                
                $('#totalDebit').text(totalDebit.toFixed(2));
                $('#totalCredit').text(totalCredit.toFixed(2));
                
                if (Math.abs(totalDebit - totalCredit) > 0.01) {
                    $('#balanceError').show();
                } else {
                    $('#balanceError').hide();
                }
            }

            $('#addLine').click(function() {
                var html = '<div class="row entry-line mb-2">' +
                    '<div class="col-md-4">' +
                    '<select name="Lines[' + lineIndex + '].LedgerID" class="form-control ledger-select">' +
                    '<option value="">Select Ledger</option>';
                
                ledgers.forEach(function(ledger) {
                    html += '<option value="' + ledger.LedgerID + '">' + ledger.LedgerName + '</option>';
                });
                
                html += '</select></div>' +
                    '<div class="col-md-3"><input name="Lines[' + lineIndex + '].DebitAmount" class="form-control debit-amount" type="number" step="0.01" placeholder="Debit" /></div>' +
                    '<div class="col-md-3"><input name="Lines[' + lineIndex + '].CreditAmount" class="form-control credit-amount" type="number" step="0.01" placeholder="Credit" /></div>' +
                    '<div class="col-md-2"><button type="button" class="btn btn-danger remove-line">Remove</button></div>' +
                    '</div>';
                
                $('#entryLines').append(html);
                lineIndex++;
            });

            $(document).on('click', '.remove-line', function() {
                $(this).closest('.entry-line').remove();
                updateTotals();
            });

            $(document).on('input', '.debit-amount, .credit-amount', function() {
                updateTotals();
            });

            $('#journalForm').submit(function(e) {
                updateTotals();
                if ($('#balanceError').is(':visible')) {
                    e.preventDefault();
                    alert('Please ensure Total Debits equal Total Credits!');
                    return false;
                }
            });
        });
    </script>
}

